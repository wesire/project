// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User and Authentication
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String
  passwordHash  String
  role          Role     @default(VIEWER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  projects      ProjectMember[]
  auditLogs     AuditLog[]
  createdProjects Project[] @relation("ProjectCreator")
  createdTasks  Task[]
  assignedTasks Task[] @relation("TaskAssignee")
  issues        Issue[]
  rfis          RFI[]
  resourceAllocations ResourceAllocation[]
}

enum Role {
  ADMIN
  PM
  QS
  SITE
  VIEWER
}

// Project Register
model Project {
  id              String   @id @default(cuid())
  projectNumber   String   @unique
  name            String
  description     String?
  status          ProjectStatus @default(PLANNING)
  startDate       DateTime
  endDate         DateTime
  budget          Float
  actualCost      Float    @default(0)
  currency        String   @default("GBP")
  location        String?
  client          String?
  
  createdById     String
  createdBy       User     @relation("ProjectCreator", fields: [createdById], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  members         ProjectMember[]
  risks           Risk[]
  changes         ChangeOrder[]
  tasks           Task[]
  sprints         Sprint[]
  resources       ResourceAllocation[]
  cashflows       Cashflow[]
  issues          Issue[]
  rfis            RFI[]
  procurements    Procurement[]
  auditLogs       AuditLog[]
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

model ProjectMember {
  id          String   @id @default(cuid())
  projectId   String
  userId      String
  role        String
  joinedAt    DateTime @default(now())
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, userId])
}

// Risk Register
model Risk {
  id              String   @id @default(cuid())
  projectId       String
  riskNumber      String
  title           String
  description     String
  category        String
  probability     Int      // 1-5
  impact          Int      // 1-5
  score           Int      // probability * impact
  status          RiskStatus @default(OPEN)
  owner           String?
  mitigation      String?
  contingency     String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, riskNumber])
}

enum RiskStatus {
  OPEN
  MITIGATED
  CLOSED
  ACCEPTED
}

// Change Log
model ChangeOrder {
  id              String   @id @default(cuid())
  projectId       String
  changeNumber    String
  title           String
  description     String
  status          ChangeStatus @default(SUBMITTED)
  requestedBy     String
  approvedBy      String?
  
  costImpact      Float    @default(0)
  timeImpact      Int      @default(0) // days
  
  submittedDate   DateTime @default(now())
  approvedDate    DateTime?
  implementedDate DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, changeNumber])
}

enum ChangeStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  IMPLEMENTED
}

// Tasks and Sprints
model Sprint {
  id          String   @id @default(cuid())
  projectId   String
  name        String
  goal        String?
  startDate   DateTime
  endDate     DateTime
  status      SprintStatus @default(PLANNED)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks       Task[]
}

enum SprintStatus {
  PLANNED
  ACTIVE
  COMPLETED
  CANCELLED
}

model Task {
  id              String   @id @default(cuid())
  projectId       String
  sprintId        String?
  taskNumber      String
  title           String
  description     String?
  status          TaskStatus @default(TODO)
  priority        Priority @default(MEDIUM)
  
  assignedToId    String?
  createdById     String
  
  estimatedHours  Float?
  actualHours     Float    @default(0)
  progress        Int      @default(0) // 0-100
  
  startDate       DateTime?
  endDate         DateTime?
  dependencies    String[] // Array of task IDs
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sprint          Sprint?  @relation(fields: [sprintId], references: [id])
  assignedTo      User?    @relation("TaskAssignee", fields: [assignedToId], references: [id])
  createdBy       User     @relation(fields: [createdById], references: [id])
  
  @@unique([projectId, taskNumber])
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  BLOCKED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Resource Allocation
model ResourceAllocation {
  id          String   @id @default(cuid())
  projectId   String
  userId      String
  resourceType String
  allocatedHours Float
  utilization Float    @default(0) // percentage
  startDate   DateTime
  endDate     DateTime
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id])
}

// Cashflow
model Cashflow {
  id          String   @id @default(cuid())
  projectId   String
  date        DateTime
  type        CashflowType
  category    String
  description String
  
  forecast    Float
  actual      Float?
  variance    Float?   @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

enum CashflowType {
  INFLOW
  OUTFLOW
}

// Issues
model Issue {
  id          String   @id @default(cuid())
  projectId   String
  issueNumber String
  title       String
  description String
  status      IssueStatus @default(OPEN)
  priority    Priority @default(MEDIUM)
  raisedBy    String
  assignedTo  String?
  
  raisedById  String
  
  dueDate     DateTime?
  resolvedDate DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  raisedByUser User    @relation(fields: [raisedById], references: [id])
  
  @@unique([projectId, issueNumber])
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

// RFI (Request for Information)
model RFI {
  id          String   @id @default(cuid())
  projectId   String
  rfiNumber   String
  title       String
  description String
  status      RFIStatus @default(OPEN)
  requestedBy String
  respondedBy String?
  
  requestedById String
  
  requestDate DateTime @default(now())
  dueDate     DateTime?
  responseDate DateTime?
  response    String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  requestedByUser User @relation(fields: [requestedById], references: [id])
  
  @@unique([projectId, rfiNumber])
}

enum RFIStatus {
  OPEN
  RESPONDED
  CLOSED
}

// Procurement
model Procurement {
  id          String   @id @default(cuid())
  projectId   String
  poNumber    String
  vendor      String
  description String
  status      ProcurementStatus @default(REQUESTED)
  
  orderValue  Float
  paidAmount  Float    @default(0)
  
  orderDate   DateTime @default(now())
  deliveryDate DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, poNumber])
}

enum ProcurementStatus {
  REQUESTED
  APPROVED
  ORDERED
  DELIVERED
  INVOICED
  PAID
}

// Audit Trail
model AuditLog {
  id          String   @id @default(cuid())
  projectId   String?
  userId      String
  action      String
  entityType  String
  entityId    String
  changes     Json?
  
  createdAt   DateTime @default(now())
  
  project     Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id])
}
